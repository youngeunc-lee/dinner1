<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ì§‘ ì €ë… ë©”ë‰´ë£°ë › (v22 - ìœ„ì¹˜ê¸°ëŠ¥ ìµœì¢…ìˆ˜ì •)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .option-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .option-card.selected {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        .counter-btn {
            transition: background-color 0.2s;
        }
        .counter-btn:hover {
            background-color: #d1d5db;
        }
        #recommendation-card, .conditional-section {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out, max-height 0.5s ease-in-out;
        }
        .hidden-section {
            opacity: 0;
            transform: translateY(-10px);
            max-height: 0;
            overflow: hidden;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
        }
        /* Gemini Modal Styles */
        #gemini-modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        #gemini-modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        /* Simple spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Toast Notification */
        #toast {
            transition: opacity 0.3s, transform 0.3s;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-700">ìš°ë¦¬ì§‘ ì €ë… ë©”ë‰´ë£°ë › ğŸ½ï¸</h1>
            <p class="text-gray-600 mt-2">AIì™€ í•¨ê»˜ ì™„ë²½í•œ ì €ë… ì‹ì‚¬ë¥¼ ê³„íší•´ë³´ì„¸ìš”!</p>
        </header>

        <main class="space-y-8">
            <!-- Selection sections -->
            <section>
                <h2 class="text-xl font-semibold mb-4 border-l-4 border-indigo-500 pl-3">1. ì–´ë–»ê²Œ ë“œì‹¤ ê±´ê°€ìš”?</h2>
                <div id="type-options" class="grid grid-cols-2 gap-4">
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="cook">
                        <div class="text-3xl mb-2">ğŸ‘©â€ğŸ³</div><div class="font-semibold">ì§ì ‘ ìš”ë¦¬</div>
                    </div>
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="delivery">
                        <div class="text-3xl mb-2">ğŸ›µ</div><div class="font-semibold">ë°°ë‹¬ ìŒì‹</div>
                    </div>
                </div>
            </section>
            
            <section>
                <h2 class="text-xl font-semibold mb-4 border-l-4 border-indigo-500 pl-3">2. ê°€ì¡±ì´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                    <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center">
                        <span class="text-lg">ì–´ë¥¸ ğŸ§‘</span>
                        <div class="flex items-center gap-3">
                            <button class="counter-btn bg-gray-200 rounded-full w-8 h-8 text-lg font-bold" onclick="updateCounter('adults', -1)">-</button>
                            <span id="adults-count" class="text-xl font-bold w-8">2</span>
                            <button class="counter-btn bg-gray-200 rounded-full w-8 h-8 text-lg font-bold" onclick="updateCounter('adults', 1)">+</button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center">
                        <span class="text-lg">ì•„ì´ ğŸ§’</span>
                        <div class="flex items-center gap-3">
                            <button class="counter-btn bg-gray-200 rounded-full w-8 h-8 text-lg font-bold" onclick="updateCounter('children', -1)">-</button>
                            <span id="children-count" class="text-xl font-bold w-8">1</span>
                            <button class="counter-btn bg-gray-200 rounded-full w-8 h-8 text-lg font-bold" onclick="updateCounter('children', 1)">+</button>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h2 class="text-xl font-semibold mb-4 border-l-4 border-indigo-500 pl-3">3. ì–´ë–¤ ì‹ì‚¬ ìë¦¬ì¸ê°€ìš”?</h2>
                <div id="occasion-options" class="grid grid-cols-3 gap-4">
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="daily"><div class="text-3xl mb-2">ğŸ¡</div><div class="font-semibold">ì¼ìƒ ì‹ì‚¬</div></div>
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="gathering"><div class="text-3xl mb-2">ğŸ‰</div><div class="font-semibold">ì†Œëª¨ì„</div></div>
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="special"><div class="text-3xl mb-2">ğŸ’–</div><div class="font-semibold">íŠ¹ë³„í•œ ë‚ </div></div>
                </div>
            </section>

            <section>
                <h2 class="text-xl font-semibold mb-4 border-l-4 border-indigo-500 pl-3">4. ì˜¤ëŠ˜ì˜ ê¸°ë¶„ì€ ì–´ë– ì„¸ìš”?</h2>
                <div id="feeling-options" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="stress"><div class="text-3xl mb-2">ğŸ˜¡</div><div class="font-semibold">ìŠ¤íŠ¸ë ˆìŠ¤ í™•!</div></div>
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="tired"><div class="text-3xl mb-2">ğŸ˜ª</div><div class="font-semibold">ëª¸ë„ ë§ˆìŒë„ ì§€ì³¤ì–´</div></div>
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="great"><div class="text-3xl mb-2">ğŸ˜„</div><div class="font-semibold">ê¸°ë¶„ ìµœê³ !</div></div>
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="rainy"><div class="text-3xl mb-2">â˜”ï¸</div><div class="font-semibold">ë¹„ë„ ì˜¤ê³  ê·¸ë˜ì„œ...</div></div>
                </div>
            </section>

            <section>
                <h2 class="text-xl font-semibold mb-4 border-l-4 border-indigo-500 pl-3">5. ì–´ë–¤ ì¢…ë¥˜ì˜ ìŒì‹ì„ ì›í•˜ì„¸ìš”?</h2>
                <div id="cuisine-options" class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="í•œì‹"><div class="text-3xl mb-2">ğŸ‡°ğŸ‡·</div><div class="font-semibold">í•œì‹</div></div>
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="ì¤‘ì‹"><div class="text-3xl mb-2">ğŸ‡¨ğŸ‡³</div><div class="font-semibold">ì¤‘ì‹</div></div>
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="ì–‘ì‹"><div class="text-3xl mb-2">ğŸ•</div><div class="font-semibold">ì–‘ì‹/ì¹˜í‚¨</div></div>
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="ë¶„ì‹"><div class="text-3xl mb-2">ë–¡ë³¶ì´</div><div class="font-semibold">ë¶„ì‹</div></div>
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="ê±´ê°•ì‹"><div class="text-3xl mb-2">ğŸ¥—</div><div class="font-semibold">ê±´ê°•ì‹</div></div>
                </div>
            </section>
            
            <!-- Dynamic Method Section -->
            <section id="method-section" class="conditional-section hidden-section">
                <h2 class="text-xl font-semibold mb-4 border-l-4 border-indigo-500 pl-3">6. ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ìš”ë¦¬ëœ ìŒì‹ì´ ì¢‹ë‚˜ìš”?</h2>
                <div id="method-options" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                    <!-- Options will be dynamically inserted here -->
                </div>
            </section>

            <!-- Cooking-specific options -->
            <div id="cooking-options" class="space-y-8 conditional-section hidden-section">
                <section>
                    <h2 class="text-xl font-semibold mb-4 border-l-4 border-indigo-500 pl-3">7. ìš”ë¦¬ ì‹œê°„ì€ ì–´ëŠ ì •ë„?</h2>
                    <div id="time-options" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="20"><div class="text-2xl mb-2">âš¡ï¸</div><div class="font-semibold">20ë¶„ ì´ë‚´</div></div>
                        <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="40"><div class="text-2xl mb-2">ğŸ³</div><div class="font-semibold">30-40ë¶„</div></div>
                        <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="60"><div class="text-2xl mb-2">â³</div><div class="font-semibold">1ì‹œê°„ ì´ìƒ</div></div>
                    </div>
                </section>
                <section>
                    <h2 class="text-xl font-semibold mb-4 border-l-4 border-indigo-500 pl-3">8. ê¼­ ì¨ì•¼ í•  ì¬ë£Œê°€ ìˆë‚˜ìš”? (ì„ íƒ)</h2>
                    <input id="ingredients" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="ì˜ˆ: íŒ½ì´ë²„ì„¯, ë‘ë¶€, ê¹€ì¹˜">
                </section>
            </div>

            <!-- Recommend Button -->
            <div class="text-center pt-4">
                <button id="recommend-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-105">
                    ë©”ë‰´ ì¶”ì²œë°›ê¸°!
                </button>
            </div>

            <!-- Recommendation Result -->
            <div id="recommendation-card" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500 hidden opacity-0 transform -translate-y-4">
                <h3 id="recommendation-title" class="text-2xl font-bold text-center mb-4">ì˜¤ëŠ˜ì˜ ì¶”ì²œ ë©”ë‰´ Top 5</h3>
                <div id="result" class="text-center"></div>
            </div>
        </main>
    </div>

    <!-- Gemini AI Modal -->
    <div id="gemini-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div id="gemini-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col opacity-0 transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h4 id="gemini-modal-title" class="text-xl font-bold text-indigo-700">AIì˜ ë‹µë³€</h4>
                <button id="gemini-modal-close" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="gemini-modal-body" class="p-6 overflow-y-auto">
                <div id="gemini-loader" class="flex justify-center items-center py-10"><div class="loader"></div></div>
                <div id="gemini-response" class="prose max-w-none whitespace-pre-wrap"></div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2">
        í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
    </div>

    <script>
        // --- Database ---
        const recipes = [
            // ì§ì ‘ ìš”ë¦¬
            { name: 'ë¼ì§€ê³ ê¸° ê¹€ì¹˜ì°Œê°œ', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'rainy', method: 'êµ­ë¬¼/ì°Œê°œ', time: 40, ingredients: ['ë¼ì§€ê³ ê¸°', 'ê¹€ì¹˜'], childMenu: 'ê³„ë€ì°œ' }, { name: 'ì°¨ëŒ ëœì¥ì°Œê°œ', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'great', method: 'êµ­ë¬¼/ì°Œê°œ', time: 20, ingredients: ['ì°¨ëŒë°•ì´', 'ëœì¥'], childMenu: 'ì–´ë¬µë³¶ìŒ' }, { name: 'ì–¼í° ìˆœë‘ë¶€ì°Œê°œ', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'rainy', method: 'êµ­ë¬¼/ì°Œê°œ', time: 20, ingredients: ['ìˆœë‘ë¶€', 'ê³„ë€'], childMenu: 'ì½©ë‚˜ë¬¼ë¬´ì¹¨' }, { name: 'ì†Œê³ ê¸° ë­‡êµ­', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'tired', method: 'êµ­ë¬¼/ì°Œê°œ', time: 60, ingredients: ['ì†Œê³ ê¸°', 'ë¬´'], childMenu: 'ë™ê·¸ë‘ë•¡' }, { name: 'ë‹­ë³¶ìŒíƒ•', type: 'cook', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'stress', method: 'êµ­ë¬¼/ì°Œê°œ', time: 60, ingredients: ['ë‹­', 'ê°ì', 'ê³ ì¶”ì¥'], childMenu: 'ì½˜ì¹˜ì¦ˆ' }, { name: 'ëˆ„ë£½ì§€ ë°±ìˆ™', type: 'cook', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'tired', method: 'êµ­ë¬¼/ì°Œê°œ', time: 60, ingredients: ['ë‹­', 'ëˆ„ë£½ì§€'], childMenu: 'ê²‰ì ˆì´' }, { name: 'ê¹€ì¹˜ë³¶ìŒë°¥', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'stress', method: 'ë©´/ë°¥', time: 20, ingredients: ['ê¹€ì¹˜', 'ë°¥', 'ê³„ë€'], childMenu: 'ê³„ë€êµ­' }, { name: 'ìŠ¤íŒ¸ë§ˆìš”ë®ë°¥', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'great', method: 'ë©´/ë°¥', time: 20, ingredients: ['ìŠ¤íŒ¸', 'ë§ˆìš”ë„¤ì¦ˆ', 'ê³„ë€'], childMenu: null }, { name: 'ê°„ì¥ê³„ë€ë°¥', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'tired', method: 'ë©´/ë°¥', time: 20, ingredients: ['ê³„ë€', 'ê°„ì¥', 'ë²„í„°'], childMenu: null }, { name: 'ë¹„ë¹”êµ­ìˆ˜', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'stress', method: 'ë©´/ë°¥', time: 20, ingredients: ['ì†Œë©´', 'ê³ ì¶”ì¥', 'ì˜¤ì´'], childMenu: 'ì‚¶ì€ê³„ë€' }, { name: 'ì œìœ¡ë³¶ìŒ', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'stress', method: 'ë³¶ìŒ/êµ¬ì´', time: 40, ingredients: ['ë¼ì§€ê³ ê¸°', 'ê³ ì¶”ì¥'], childMenu: 'ìƒì¶”ìŒˆ' }, { name: 'ì˜¤ì§•ì–´ë³¶ìŒ', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'stress', method: 'ë³¶ìŒ/êµ¬ì´', time: 40, ingredients: ['ì˜¤ì§•ì–´', 'ê³ ì¶”ì¥'], childMenu: 'ì½©ë‚˜ë¬¼êµ­' }, { name: 'ì†Œë¶ˆê³ ê¸°', type: 'cook', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'great', method: 'ë³¶ìŒ/êµ¬ì´', time: 40, ingredients: ['ì†Œê³ ê¸°', 'ë²„ì„¯'], childMenu: null }, { name: 'LAê°ˆë¹„êµ¬ì´', type: 'cook', occasion: 'special', cuisine: 'í•œì‹', feeling: 'great', method: 'ë³¶ìŒ/êµ¬ì´', time: 60, ingredients: ['LAê°ˆë¹„', 'ê°„ì¥'], childMenu: 'ì–‘íŒŒì ˆì„' }, { name: 'ê°„ì¥ ì°œë‹­', type: 'cook', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'great', method: 'ì°œ/ì¡°ë¦¼', time: 60, ingredients: ['ë‹­', 'ê°ì', 'ë‹¹ë©´'], childMenu: null }, { name: 'ë¼ì§€ê³ ê¸° ê¹€ì¹˜ì°œ', type: 'cook', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'rainy', method: 'ì°œ/ì¡°ë¦¼', time: 60, ingredients: ['ë¼ì§€ê³ ê¸°', 'ê¹€ì¹˜'], childMenu: 'ê³„ë€ë§ì´' }, { name: 'ë‘ë¶€ì¡°ë¦¼', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'tired', method: 'ì°œ/ì¡°ë¦¼', time: 20, ingredients: ['ë‘ë¶€', 'ê°„ì¥'], childMenu: 'ê¹€' }, { name: 'ê³ ë“±ì–´ì¡°ë¦¼', type: 'cook', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'rainy', method: 'ì°œ/ì¡°ë¦¼', time: 40, ingredients: ['ê³ ë“±ì–´', 'ë¬´'], childMenu: 'ë¯¸ì—­êµ­' }, { name: 'ì—ì–´í”„ë¼ì´ì–´ í†µì‚¼ê²¹', type: 'cook', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'great', method: 'íŠ€ê¹€/ì˜¤ë¸', time: 60, ingredients: ['ì‚¼ê²¹ì‚´', 'í—ˆë¸Œì†”íŠ¸'], childMenu: 'ë¹„ë¹”ë©´' }, { name: 'ë§ˆíŒŒë‘ë¶€ ë®ë°¥', type: 'cook', occasion: 'daily', cuisine: 'ì¤‘ì‹', feeling: 'stress', method: 'ë©´/ë°¥', time: 20, ingredients: ['ë‘ë¶€', 'ë¼ì§€ê³ ê¸°', 'ë‘ë°˜ì¥'], childMenu: 'ê³„ë€íƒ•' }, { name: 'ê³ ì¶”ì¡ì±„', type: 'cook', occasion: 'gathering', cuisine: 'ì¤‘ì‹', feeling: 'great', method: 'ë³¶ìŒ/êµ¬ì´', time: 40, ingredients: ['ë¼ì§€ê³ ê¸°', 'í”¼ë§', 'ê³ ì¶”'], childMenu: 'ê½ƒë¹µ' }, { name: 'í¬ë¦¼ íŒŒìŠ¤íƒ€', type: 'cook', occasion: 'daily', cuisine: 'ì–‘ì‹', feeling: 'great', method: 'ë©´/ë°¥', time: 20, ingredients: ['íŒŒìŠ¤íƒ€ë©´', 'ìƒí¬ë¦¼', 'ë² ì´ì»¨'], childMenu: null }, { name: 'í† ë§ˆí†  ë¦¬ì¡°ë˜', type: 'cook', occasion: 'daily', cuisine: 'ì–‘ì‹', feeling: 'tired', method: 'ë©´/ë°¥', time: 40, ingredients: ['ìŒ€', 'í† ë§ˆí† ì†ŒìŠ¤'], childMenu: 'í”¼í´' }, { name: 'í•¨ë°•ìŠ¤í…Œì´í¬', type: 'cook', occasion: 'special', cuisine: 'ì–‘ì‹', feeling: 'great', method: 'ë³¶ìŒ/êµ¬ì´', time: 40, ingredients: ['ì†Œê³ ê¸°', 'ë¼ì§€ê³ ê¸°', 'ì–‘íŒŒ'], childMenu: null }, { name: 'ì¹˜í‚¨ ê°€ë¼ì•„ê²Œ', type: 'cook', occasion: 'gathering', cuisine: 'ì–‘ì‹', feeling: 'great', method: 'íŠ€ê¹€/ì˜¤ë¸', time: 40, ingredients: ['ë‹­ë‹¤ë¦¬ì‚´', 'íŠ€ê¹€ê°€ë£¨'], childMenu: 'ì–‘ë°°ì¶”ìƒëŸ¬ë“œ' }, { name: 'ì½˜ì¹˜ì¦ˆ', type: 'cook', occasion: 'gathering', cuisine: 'ì–‘ì‹', feeling: 'great', method: 'íŠ€ê¹€/ì˜¤ë¸', time: 20, ingredients: ['ì˜¥ìˆ˜ìˆ˜ì½˜', 'ì¹˜ì¦ˆ', 'ë§ˆìš”ë„¤ì¦ˆ'], childMenu: null },
            // ë°°ë‹¬ ìŒì‹
            { name: 'ë§¤ìš´ ì¡±ë°œ', type: 'delivery', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'stress', method: 'ì°œ/ì¡°ë¦¼', childMenu: 'ì£¼ë¨¹ë°¥' }, { name: 'ë³´ìŒˆ', type: 'delivery', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'great', method: 'ì°œ/ì¡°ë¦¼', childMenu: 'ë§‰êµ­ìˆ˜' }, { name: 'ì•„êµ¬ì°œ', type: 'delivery', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'stress', method: 'ì°œ/ì¡°ë¦¼', childMenu: 'ë³¶ìŒë°¥' }, { name: 'ì°œë‹­', type: 'delivery', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'great', method: 'ì°œ/ì¡°ë¦¼', childMenu: 'ëˆ„ë£½ì§€' }, { name: 'ê°ìíƒ•', type: 'delivery', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'rainy', method: 'êµ­ë¬¼/ì°Œê°œ', childMenu: 'ë¼ë©´ì‚¬ë¦¬' }, { name: 'ë¶€ëŒ€ì°Œê°œ', type: 'delivery', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'rainy', method: 'êµ­ë¬¼/ì°Œê°œ', childMenu: 'í–„ì‚¬ë¦¬' }, { name: 'ìœ¡íšŒë¹„ë¹”ë°¥', type: 'delivery', occasion: 'daily', cuisine: 'í•œì‹', feeling: 'tired', method: 'ë©´/ë°¥', childMenu: 'ì†Œê³ ê¸°ë­‡êµ­' }, { name: 'ê¹€ì¹˜ì „', type: 'delivery', occasion: 'gathering', cuisine: 'í•œì‹', feeling: 'rainy', method: 'ë³¶ìŒ/êµ¬ì´', childMenu: 'ë§‰ê±¸ë¦¬(ì–´ë¥¸ìš©!)' }, { name: 'ì§œì¥ë©´ & íƒ•ìˆ˜ìœ¡', type: 'delivery', occasion: 'daily', cuisine: 'ì¤‘ì‹', feeling: 'great', method: 'ë©´/ë°¥', childMenu: 'êµ°ë§Œë‘' }, { name: 'ì¤‘í™” ë¹„ë¹”ë°¥', type: 'delivery', occasion: 'daily', cuisine: 'ì¤‘ì‹', feeling: 'stress', method: 'ë©´/ë°¥', childMenu: 'ì§¬ë½•êµ­ë¬¼' }, { name: 'í•´ë¬¼ ì§¬ë½•', type: 'delivery', occasion: 'daily', cuisine: 'ì¤‘ì‹', feeling: 'rainy', method: 'êµ­ë¬¼/ì°Œê°œ', childMenu: 'êµ°ë§Œë‘' }, { name: 'ë§ˆë¼íƒ•', type: 'delivery', occasion: 'gathering', cuisine: 'ì¤‘ì‹', feeling: 'stress', method: 'êµ­ë¬¼/ì°Œê°œ', childMenu: 'ê¿”ë°”ë¡œìš°' }, { name: 'ì–‘ì¥í”¼', type: 'delivery', occasion: 'gathering', cuisine: 'ì¤‘ì‹', feeling: 'great', method: 'ë³¶ìŒ/êµ¬ì´', childMenu: 'ê³ ëŸ‰ì£¼(ì–´ë¥¸ìš©!)' }, { name: 'í›„ë¼ì´ë“œ & ì–‘ë…ì¹˜í‚¨', type: 'delivery', occasion: 'gathering', cuisine: 'ì–‘ì‹', feeling: 'great', method: 'íŠ€ê¹€/ì˜¤ë¸', childMenu: 'ì¹˜ì¦ˆë³¼' }, { name: 'ë§¤ìš´ ìˆ¯ë¶ˆ ë°”ë² í ì¹˜í‚¨', type: 'delivery', occasion: 'gathering', cuisine: 'ì–‘ì‹', feeling: 'stress', method: 'íŠ€ê¹€/ì˜¤ë¸', childMenu: 'ìš°ë™ì‚¬ë¦¬' }, { name: 'í”¼ì', type: 'delivery', occasion: 'gathering', cuisine: 'ì–‘ì‹', feeling: 'great', method: 'íŠ€ê¹€/ì˜¤ë¸', childMenu: 'ì¹˜ì¦ˆì˜¤ë¸ìŠ¤íŒŒê²Œí‹°' }, { name: 'ë¡œì œ íŒŒìŠ¤íƒ€', type: 'delivery', occasion: 'daily', cuisine: 'ì–‘ì‹', feeling: 'great', method: 'ë©´/ë°¥', childMenu: 'ë§ˆëŠ˜ë¹µ' }, { name: 'ìŠ¤í…Œì´í¬', type: 'delivery', occasion: 'special', cuisine: 'ì–‘ì‹', feeling: 'great', method: 'ë³¶ìŒ/êµ¬ì´', childMenu: 'ê°€ë‹ˆì‰¬' }, { name: 'ëˆê¹ŒìŠ¤', type: 'delivery', occasion: 'daily', cuisine: 'ì–‘ì‹', feeling: 'tired', method: 'íŠ€ê¹€/ì˜¤ë¸', childMenu: 'ë¯¸ë‹ˆìš°ë™' }, { name: 'ì—½ê¸° ë–¡ë³¶ì´', type: 'delivery', occasion: 'gathering', cuisine: 'ë¶„ì‹', feeling: 'stress', method: 'êµ­ë¬¼/ì°Œê°œ', childMenu: 'ìˆœëŒ€, ì»µë°¥' }, { name: 'ë¡œì œ ë–¡ë³¶ì´', type: 'delivery', occasion: 'gathering', cuisine: 'ë¶„ì‹', feeling: 'great', method: 'êµ­ë¬¼/ì°Œê°œ', childMenu: 'ì¤‘êµ­ë‹¹ë©´' }, { name: 'ë¼ë³¶ì´', type: 'delivery', occasion: 'daily', cuisine: 'ë¶„ì‹', feeling: 'rainy', method: 'êµ­ë¬¼/ì°Œê°œ', childMenu: 'ê¹€ë°¥' }, { name: 'ì«„ë©´', type: 'delivery', occasion: 'daily', cuisine: 'ë¶„ì‹', feeling: 'stress', method: 'ë©´/ë°¥', childMenu: 'íŠ€ê¹€ë§Œë‘' }, { name: 'ë”°ëœ»í•œ ìŒ€êµ­ìˆ˜', type: 'delivery', occasion: 'daily', cuisine: 'ê¸°íƒ€', feeling: 'tired', method: 'êµ­ë¬¼/ì°Œê°œ', childMenu: 'ì§œì¡°' },
            { name: 'Hoedeopbap (ìƒì„  ë¹„ë¹”ë°¥)', type: 'cook', occasion: 'daily', cuisine: 'ê±´ê°•ì‹', feeling: 'great', method: 'ë©´/ë°¥', time: 20, ingredients: ['ìƒì„ ', 'ì±„ì†Œ', 'ê³ ì¶”ì¥'], childMenu: 'ì•¼ì±„ë¬´ì¹¨' }, { name: 'Samgyetang (ì‚¼ê³„íƒ•)', type: 'cook', occasion: 'special', cuisine: 'ê±´ê°•ì‹', feeling: 'tired', method: 'êµ­ë¬¼/ì°Œê°œ', time: 60, ingredients: ['ë‹­', 'ì¸ì‚¼', 'ëŒ€ì¶”'], childMenu: 'ê¹€ì¹˜' }, { name: 'Yukgaejang (ìœ¡ê°œì¥)', type: 'cook', occasion: 'daily', cuisine: 'ê±´ê°•ì‹', feeling: 'rainy', method: 'êµ­ë¬¼/ì°Œê°œ', time: 60, ingredients: ['ì†Œê³ ê¸°', 'ì±„ì†Œ', 'ê³ ì¶§ê°€ë£¨'], childMenu: null }, { name: 'Jjimdak (ì°œë‹­)', type: 'cook', occasion: 'gathering', cuisine: 'ê±´ê°•ì‹', feeling: 'great', method: 'ì°œ/ì¡°ë¦¼', time: 40, ingredients: ['ë‹­', 'ì±„ì†Œ', 'ê°„ì¥'], childMenu: 'ë‹¹ë©´' }, { name: 'Gyeran Mari (ê³„ë€ë§ì´)', type: 'cook', occasion: 'daily', cuisine: 'ê±´ê°•ì‹', feeling: 'tired', method: 'ë³¶ìŒ/êµ¬ì´', time: 20, ingredients: ['ê³„ë€', 'ë‹¹ê·¼', 'ëŒ€íŒŒ'], childMenu: 'ì•¼ì±„ìŠ¤í‹±' }, { name: 'Gyeran Jjim (ê³„ë€ì°œ)', type: 'cook', occasion: 'daily', cuisine: 'ê±´ê°•ì‹', feeling: 'stress', method: 'ì°œ/ì¡°ë¦¼', time: 20, ingredients: ['ê³„ë€', 'ì†Œê¸ˆ', 'ë¬¼'], childMenu: 'ë‘ë¶€' }, { name: 'Gamja-tang (ê°ìíƒ•)', type: 'cook', occasion: 'gathering', cuisine: 'ê±´ê°•ì‹', feeling: 'rainy', method: 'êµ­ë¬¼/ì°Œê°œ', time: 60, ingredients: ['ë¼ì§€ê³ ê¸°', 'ê°ì', 'ë“¤ê¹¨'], childMenu: 'ê¹€' }, { name: 'Kimchi Fried Rice (ê¹€ì¹˜ë³¶ìŒë°¥)', type: 'cook', occasion: 'daily', cuisine: 'ê±´ê°•ì‹', feeling: 'great', method: 'ë³¶ìŒ/êµ¬ì´', time: 20, ingredients: ['ê¹€ì¹˜', 'ë°¥', 'ì•¼ì±„'], childMenu: 'ê³„ë€' }, { name: 'Dak Bulgogi (ë‹­ë¶ˆê³ ê¸°)', type: 'cook', occasion: 'daily', cuisine: 'ê±´ê°•ì‹', feeling: 'great', method: 'ë³¶ìŒ/êµ¬ì´', time: 40, ingredients: ['ë‹­', 'ê°„ì¥', 'ë§ˆëŠ˜'], childMenu: 'ìƒì¶”ìŒˆ' }, { name: 'Spicy Chicken Bulgogi (ë§¤ìš´ ë‹­ë¶ˆê³ ê¸°)', type: 'cook', occasion: 'daily', cuisine: 'ê±´ê°•ì‹', feeling: 'stress', method: 'ë³¶ìŒ/êµ¬ì´', time: 40, ingredients: ['ë‹­', 'ê³ ì¶”ì¥', 'ì•¼ì±„'], childMenu: null }, { name: 'Dakdoritang (ë‹­ë„ë¦¬íƒ•)', type: 'cook', occasion: 'daily', cuisine: 'ê±´ê°•ì‹', feeling: 'rainy', method: 'êµ­ë¬¼/ì°Œê°œ', time: 60, ingredients: ['ë‹­', 'ê°ì', 'ê³ ì¶”ì¥'], childMenu: 'ì•¼ì±„' }, { name: 'Air Fryer Korean Fried Chicken (ì—ì–´í”„ë¼ì´ì–´ ì¹˜í‚¨)', type: 'cook', occasion: 'gathering', cuisine: 'ê±´ê°•ì‹', feeling: 'great', method: 'íŠ€ê¹€/ì˜¤ë¸', time: 40, ingredients: ['ë‹­', 'ê³ ì¶”ì¥', 'ë¹µê°€ë£¨'], childMenu: 'ì¹˜ì¦ˆë³¼' }, { name: 'Dak Galbi (ë‹­ê°ˆë¹„)', type: 'cook', occasion: 'gathering', cuisine: 'ê±´ê°•ì‹', feeling: 'great', method: 'ë³¶ìŒ/êµ¬ì´', time: 40, ingredients: ['ë‹­', 'ê³ ì¶”ì¥', 'ì¹˜ì¦ˆ'], childMenu: 'ì•¼ì±„' }, { name: 'Bibimbap (ë¹„ë¹”ë°¥)', type: 'delivery', occasion: 'daily', cuisine: 'ê±´ê°•ì‹', feeling: 'tired', method: 'ë©´/ë°¥', childMenu: 'ê³„ë€' }, { name: 'Sundubu Jjigae (ìˆœë‘ë¶€ì°Œê°œ)', type: 'delivery', occasion: 'daily', cuisine: 'ê±´ê°•ì‹', feeling: 'rainy', method: 'êµ­ë¬¼/ì°Œê°œ', childMenu: 'ê¹€ì¹˜' }
        ];

        // --- State Management ---
        const selection = { type: null, adults: 2, children: 1, occasion: null, feeling: null, cuisine: null, method: null, time: null };
        let cuisineToMethodMap = {};

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            buildCuisineMethodMap();
            setupTypeSelection();
            setupCuisineSelection();
            setupOptionSelection('occasion-options', 'occasion');
            setupOptionSelection('feeling-options', 'feeling');
            setupOptionSelection('method-options', 'method');
            setupOptionSelection('time-options', 'time');
            document.getElementById('recommend-btn').addEventListener('click', getRecommendation);
            
            const modalOverlay = document.getElementById('gemini-modal-overlay');
            const modalCloseBtn = document.getElementById('gemini-modal-close');
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
            modalCloseBtn.addEventListener('click', closeModal);
        });

        // --- Core Functions ---
        function updateCounter(type, value) {
            const countElement = document.getElementById(`${type}-count`);
            let currentCount = parseInt(countElement.innerText);
            currentCount += value;
            if (currentCount < 0) currentCount = 0;
            countElement.innerText = currentCount;
            selection[type] = currentCount;
        }

        function buildCuisineMethodMap() {
            recipes.forEach(recipe => {
                if (!cuisineToMethodMap[recipe.cuisine]) {
                    cuisineToMethodMap[recipe.cuisine] = new Set();
                }
                if (recipe.method) {
                     cuisineToMethodMap[recipe.cuisine].add(recipe.method);
                }
            });
            for (const cuisine in cuisineToMethodMap) {
                cuisineToMethodMap[cuisine] = Array.from(cuisineToMethodMap[cuisine]);
            }
        }

        function setupTypeSelection() {
            const container = document.getElementById('type-options');
            const cookingOptionsDiv = document.getElementById('cooking-options');
            container.addEventListener('click', (e) => {
                const card = e.target.closest('.option-card');
                if (!card) return;
                container.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selection.type = card.dataset.value;
                if (selection.type === 'cook') {
                    cookingOptionsDiv.classList.remove('hidden-section');
                } else {
                    cookingOptionsDiv.classList.add('hidden-section');
                }
            });
        }
        
        function setupCuisineSelection() {
            const container = document.getElementById('cuisine-options');
            const methodSection = document.getElementById('method-section');
            container.addEventListener('click', (e) => {
                const card = e.target.closest('.option-card');
                if (!card) return;

                container.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                
                const selectedCuisine = card.dataset.value;
                selection.cuisine = selectedCuisine;
                selection.method = null; 
                
                const availableMethods = cuisineToMethodMap[selectedCuisine] || [];
                updateMethodOptions(availableMethods);
                methodSection.classList.remove('hidden-section');
            });
        }
        
        function updateMethodOptions(methods) {
            const container = document.getElementById('method-options');
            container.innerHTML = ''; 
            const methodIcons = { 'êµ­ë¬¼/ì°Œê°œ': 'ğŸ²', 'ì°œ/ì¡°ë¦¼': 'ğŸ¥˜', 'ë³¶ìŒ/êµ¬ì´': 'ğŸ³', 'ë©´/ë°¥': 'ğŸš', 'íŠ€ê¹€/ì˜¤ë¸': 'ğŸ—' };

            methods.forEach(method => {
                const icon = methodIcons[method] || 'ğŸ´';
                const cardHTML = `
                    <div class="option-card bg-white p-4 rounded-lg shadow-sm border-2 border-transparent text-center" data-value="${method}">
                        <div class="text-3xl mb-2">${icon}</div>
                        <div class="font-semibold">${method}</div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHTML);
            });
        }

        function setupOptionSelection(containerId, selectionKey) {
            const container = document.getElementById(containerId);
            container.addEventListener('click', (e) => {
                const card = e.target.closest('.option-card');
                if (!card) return;
                container.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selection[selectionKey] = card.dataset.value;
            });
        }
        
        function showMessage(title, message) {
            const recommendationCard = document.getElementById('recommendation-card');
            const titleEl = document.getElementById('recommendation-title');
            const resultDiv = document.getElementById('result');

            titleEl.textContent = title;
            resultDiv.innerHTML = `<p class="text-red-500 font-semibold">${message}</p>`;

            recommendationCard.classList.remove('hidden');
            setTimeout(() => recommendationCard.classList.remove('opacity-0', '-translate-y-4'), 10);
        }

        function getRecommendation() {
            if (!selection.type || !selection.occasion || !selection.feeling || !selection.cuisine || !selection.method) {
                showMessage('âš ï¸ í™•ì¸í•´ì£¼ì„¸ìš”!', 'ëª¨ë“  í•„ìˆ˜ í•­ëª©(1~5ë²ˆ)ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            let finalRecipes = [];
            
            // --- Fallback Logic ---
            const filterAndSort = (filters) => {
                let possible = recipes.filter(r => {
                    for (const key in filters) {
                        if (r[key] !== filters[key]) return false;
                    }
                    return true;
                });

                if (filters.type === 'cook') {
                    if (selection.time) {
                        possible = possible.filter(r => r.time <= parseInt(selection.time));
                    }
                    const userIngredients = document.getElementById('ingredients').value.split(',').map(item => item.trim()).filter(Boolean);
                    if (userIngredients.length > 0 && possible.length > 1) {
                        possible.forEach(r => {
                            r.score = 0;
                            userIngredients.forEach(ing => {
                                if (r.ingredients && r.ingredients.some(recipeIng => recipeIng.includes(ing)) || r.name.includes(ing)) r.score++;
                            });
                        });
                        possible.sort((a, b) => b.score - a.score);
                    }
                }
                return possible;
            };

            const baseFilters = { type: selection.type, occasion: selection.occasion, feeling: selection.feeling, cuisine: selection.cuisine, method: selection.method };
            
            finalRecipes = filterAndSort(baseFilters);

            if (finalRecipes.length === 0) { // Fallback 1: Relax method
                const relaxedFilters = { ...baseFilters };
                delete relaxedFilters.method;
                finalRecipes = filterAndSort(relaxedFilters);
            }
            if (finalRecipes.length === 0) { // Fallback 2: Relax feeling
                const relaxedFilters = { ...baseFilters };
                delete relaxedFilters.feeling;
                delete relaxedFilters.method;
                finalRecipes = filterAndSort(relaxedFilters);
            }
            if (finalRecipes.length === 0) { // Fallback 3: Relax occasion
                const relaxedFilters = { ...baseFilters };
                delete relaxedFilters.occasion;
                delete relaxedFilters.feeling;
                delete relaxedFilters.method;
                finalRecipes = filterAndSort(relaxedFilters);
            }
            
            if (finalRecipes.length === 0) {
                showMessage('ï¿½ ì•„ì‰¬ì›Œìš”', 'ì„ íƒí•˜ì‹  ì¡°ê±´ì— ë”± ë§ëŠ” ë©”ë‰´ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë‹¤ë¥¸ ì˜µì…˜ì„ ì„ íƒí•´ë³´ëŠ” ê±´ ì–´ë– ì„¸ìš”?');
                return;
            }
            displayResult(finalRecipes.slice(0, 5));
        }

        function displayResult(recipesToShow) {
            const recommendationCard = document.getElementById('recommendation-card');
            const titleEl = document.getElementById('recommendation-title');
            const resultDiv = document.getElementById('result');
            
            titleEl.textContent = 'ì˜¤ëŠ˜ì˜ ì¶”ì²œ ë©”ë‰´ Top 5';
            let html = '<ol class="space-y-4 text-left">';
            recipesToShow.forEach((recipe, index) => {
                const recipeName = recipe.name;
                const feelingMap = { 'stress': 'ìŠ¤íŠ¸ë ˆìŠ¤ í™•', 'tired': 'ì§€ì¹œ ë‚ ', 'great': 'ê¸°ë¶„ ìµœê³ ', 'rainy': 'ë¹„ ì˜¤ëŠ” ë‚ ' };
                const occasionMap = { 'daily': 'ì¼ìƒ ì‹ì‚¬', 'gathering': 'ì†Œëª¨ì„', 'special': 'íŠ¹ë³„í•œ ë‚ ' };
                
                let tags = `#${occasionMap[recipe.occasion]} #${feelingMap[recipe.feeling]} #${recipe.cuisine} #${recipe.method}`;
                if(recipe.type === 'cook') { tags += ` #${recipe.time}ë¶„ì†Œìš”`; } else { tags += ` #ë°°ë‹¬ìŒì‹`; }
                
                html += `<li class="p-4 border rounded-lg bg-gray-50">
                            <div class="font-bold text-xl text-indigo-700">${index + 1}. ${recipeName}</div>`;
                if (recipe.childMenu && selection.children > 0) {
                    html += `<p class="mt-1 text-sm text-gray-600">ì•„ì´ì™€ í•¨ê»˜ë¼ë©´ <span class="font-semibold text-green-600">${recipe.childMenu}</span> ë©”ë‰´ë„ ì¢‹ì•„ìš”!</p>`;
                }
                html += `<div class="mt-2 text-xs text-gray-500 bg-gray-200 inline-block px-2 py-1 rounded-full">${tags}</div>`;
                
                html += `<div class="mt-3 flex flex-wrap gap-2">`;
                if (recipe.type === 'cook') {
                    html += `<button onclick="getGeminiResponse('${recipeName}', 'recipe')" class="text-sm bg-indigo-100 text-indigo-700 font-semibold py-1 px-3 rounded-full hover:bg-indigo-200 transition-colors">âœ¨ ê°„ë‹¨ ë ˆì‹œí”¼</button>
                             <button onclick="getGeminiResponse('${recipeName}', 'sides')" class="text-sm bg-green-100 text-green-700 font-semibold py-1 px-3 rounded-full hover:bg-green-200 transition-colors">âœ¨ ì–´ìš¸ë¦¬ëŠ” ë°˜ì°¬</button>`;
                }
                if (recipe.type === 'delivery') {
                    html += `<button onclick="getGeminiResponse('${recipeName}', 'location')" class="text-sm bg-yellow-100 text-yellow-800 font-semibold py-1 px-3 rounded-full hover:bg-yellow-200 transition-colors">ğŸ“ ì£¼ë³€ ë§›ì§‘ ì°¾ê¸°</button>`;
                }
                html += `<button onclick="shareRecipe('${recipeName}', '${tags}')" class="text-sm bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-full hover:bg-gray-300 transition-colors">ğŸ”— ê³µìœ í•˜ê¸°</button>`;
                html += `</div></li>`;
            });
            html += '</ol>';
            resultDiv.innerHTML = html;

            recommendationCard.classList.remove('hidden');
            setTimeout(() => recommendationCard.classList.remove('opacity-0', '-translate-y-4'), 10);
        }
        
        // --- Utility & Gemini AI Functions ---
        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast();
        }

        function shareRecipe(name, tags) {
            const shareText = `ì˜¤ëŠ˜ ì €ë… ë©”ë‰´ ì¶”ì²œ!\n\n- ë©”ë‰´: ${name}\n- íƒœê·¸: ${tags.replace(/ #/g, ', #')}`;
            copyToClipboard(shareText);
        }

        function openModal() {
            const modalOverlay = document.getElementById('gemini-modal-overlay');
            const modalContent = document.getElementById('gemini-modal-content');
            modalOverlay.classList.remove('hidden');
            modalOverlay.classList.add('flex');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                modalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function closeModal() {
            const modalOverlay = document.getElementById('gemini-modal-overlay');
            const modalContent = document.getElementById('gemini-modal-content');
            modalOverlay.classList.add('opacity-0');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modalOverlay.classList.add('hidden');
                modalOverlay.classList.remove('flex');
            }, 300);
        }

        async function getGeminiResponse(menuName, type) {
            const modalTitle = document.getElementById('gemini-modal-title');
            const loader = document.getElementById('gemini-loader');
            const responseDiv = document.getElementById('gemini-response');

            loader.style.display = 'flex';
            responseDiv.textContent = '';
            
            let prompt = '';
            let kidFriendlyPrompt = selection.children > 0 ? " ì•„ì´ë„ ë¨¹ì„ ìˆ˜ ìˆê²Œ ë§µì§€ ì•Šê²Œ ë§Œë“œëŠ” íŒë„ í¬í•¨í•´ì£¼ë©´ ì¢‹ê² ì–´." : "";

            if (type === 'recipe') {
                modalTitle.textContent = `AIê°€ ì œì•ˆí•˜ëŠ” '${menuName}' ë ˆì‹œí”¼`;
                prompt = `'${menuName}'ì„ ì§‘ì—ì„œ ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë ˆì‹œí”¼ë¥¼ ì•Œë ¤ì¤˜. ìš”ë¦¬ ì´ˆë³´ìë„ ë”°ë¼í•˜ê¸° ì‰½ê²Œ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•´ì¤˜.${kidFriendlyPrompt}`;
            } else if (type === 'sides') {
                modalTitle.textContent = `AIê°€ ì¶”ì²œí•˜ëŠ” '${menuName}'ê³¼ ì–´ìš¸ë¦¬ëŠ” ë°˜ì°¬`;
                prompt = `'${menuName}'ì„ ë©”ì¸ ë©”ë‰´ë¡œ ì €ë… ì‹ì‚¬ë¥¼ í•  ê±°ì•¼. ì´ ë©”ë‰´ì™€ ì˜ ì–´ìš¸ë¦¬ëŠ” í•œêµ­ì‹ ë°˜ì°¬ 3ê°€ì§€ë¥¼ ì¶”ì²œí•˜ê³ , ì™œ ì˜ ì–´ìš¸ë¦¬ëŠ”ì§€ ê°„ë‹¨í•˜ê²Œ ì´ìœ ë„ ì„¤ëª…í•´ì¤˜.`;
            } else if (type === 'location') {
                modalTitle.textContent = `AIê°€ ì¶”ì²œí•˜ëŠ” '${menuName}' ì£¼ë³€ ë§›ì§‘`;
                openModal(); // Open modal first to show loading/permission state
                try {
                    const address = await getUserAddress();
                    prompt = `í˜„ì¬ ìœ„ì¹˜ëŠ” '${address}'ì…ë‹ˆë‹¤. ë°°ë‹¬ ìŒì‹ìœ¼ë¡œ '${menuName}'ì„ ë¨¹ê³  ì‹¶ìŠµë‹ˆë‹¤. ì´ ì£¼ë³€ì—ì„œ '${menuName}'ìœ¼ë¡œ ìœ ëª…í•œ ë¡œì»¬ ë§›ì§‘ ìœ„ì£¼ë¡œ 3ê³³ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”. ëŒ€í˜• í”„ëœì°¨ì´ì¦ˆë³´ë‹¤ëŠ” ê·¸ ì§€ì—­ì—ì„œë§Œ ë§›ë³¼ ìˆ˜ ìˆëŠ” ìˆ¨ì€ ë§›ì§‘ì´ë©´ ë” ì¢‹ìŠµë‹ˆë‹¤. ê° ì‹ë‹¹ì˜ íŠ¹ì§•ë„ í•œ ì¤„ë¡œ ê°„ë‹¨í•˜ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”.`;
                } catch (error) {
                    responseDiv.textContent = `ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`;
                    loader.style.display = 'none';
                    return;
                }
            }
            
            if (type !== 'location') {
                openModal();
            }

            try {
                const resultText = await callGeminiAPIWithExponentialBackoff(prompt);
                responseDiv.textContent = resultText;
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                responseDiv.textContent = 'AI ì‘ë‹µì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            } finally {
                loader.style.display = 'none';
            }
        }

        function getUserAddress() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    return reject(new Error("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
                }
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            // Using a free, public reverse geocoding service
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                            if (!response.ok) {
                                throw new Error("ì£¼ì†Œ ë³€í™˜ ì„œë²„ì—ì„œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                            }
                            const data = await response.json();
                            if (data && data.display_name) {
                                resolve(data.display_name);
                            } else {
                                reject(new Error("í˜„ì¬ ìœ„ì¹˜ì˜ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
                            }
                        } catch (e) {
                            reject(new Error("ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
                        }
                    },
                    (error) => {
                        let message = "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                message = "ìœ„ì¹˜ ì •ë³´ ì œê³µì„ ê±°ë¶€í•˜ì…¨ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message = "í˜„ì¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                                break;
                            case error.TIMEOUT:
                                message = "ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.";
                                break;
                        }
                        reject(new Error(message));
                    }
                );
            });
        }


        async function callGeminiAPIWithExponentialBackoff(prompt, maxRetries = 3) {
            // =================================================================
            // =================== ì¤‘ìš”! ì—¬ê¸°ì— API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”! ===================
            // ì•„ë˜ "YOUR_API_KEY" ë¶€ë¶„ì„ ë³µì‚¬í•œ API í‚¤ë¡œ ë°”ê¿”ì£¼ì„¸ìš”.
            const apiKey = "YOUR_API_KEY"; 
            // =================================================================
            
            if (apiKey === "YOUR_API_KEY" || !apiKey) {
                const responseDiv = document.getElementById('gemini-response');
                responseDiv.textContent = 'ì˜¤ë¥˜: Gemini API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì½”ë“œì—ì„œ "YOUR_API_KEY" ë¶€ë¶„ì„ ìì‹ ì˜ í‚¤ë¡œ êµì²´í•´ì£¼ì„¸ìš”.';
                const loader = document.getElementById('gemini-loader');
                loader.style.display = 'none';
                return; // Stop the function if the key is missing
            }

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status >= 500) { throw new Error(`API request failed with status ${response.status}`); }
                        const errorResult = await response.json();
                        throw new Error(errorResult.error?.message || 'API request failed');
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Invalid response structure from API');
                    }
                } catch (error) {
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`);
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

    </script>
</body>
</html>
ï¿½
